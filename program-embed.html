<style>
  div, span {
    font-family: "Open Sans";
  }
  h2 {
    margin-top: 40px;
    margin-bottom: 0;
  }
  p {
    margin-bottom: 0;
  }
  h3 {
    margin-top: 20px;
    margin-bottom: 5px;
  }
  .jumpLink {
    margin-right: 12px;
    line-height: 30px;
  }
  .toTopLink {
    margin-bottom: 15px;
    display: block;
    font-size: 14px;
  }
  .flex {
    display: flex;
  }
  .hidden {
    display: none;
  }
  .songList {
    flex-direction: column;
  }
  .songWrapper {
    flex-direction: column;
    margin-bottom: 10px;
  }

  [data-lyricsKey], section {
    scroll-margin-top: 60px;
  }
  section#top {
    margin-top: 12px;
  }

  @media (min-width: 600px) {
    .songHeading {
      flex-direction: row;
      flex-wrap: wrap;
      line-height: 29px;
    }
    .songTitle {
      display: flex;
      align-self: flex-start;
      flex-grow: 1;
    }
    .songTitle::after {
      content: '';
      align-self: stretch;
      flex: 1;
      border-bottom: 1px dotted black;
      margin-bottom: 8px;
      margin-left: 5px;
    }
    .songCredit {
      align-self: flex-end;
      flex-grow: 1;
    }
    .songCredit::before {
      content: '';
      align-self: stretch;
      flex: 1;
      border-bottom: 1px dotted black;
      margin-bottom: 8px;
      margin-right: 5px;
      margin-left: 0.75px;
    }
    .soloists {
      align-self: flex-end;
      text-align: end;
      font-size: 14px;
      max-width: 70%;
      margin-top: 2px;
    }
  }
  @media (max-width: 599px) {
    .songHeading {
      flex-direction: column;
    }
    .songTitleText {
      font-weight: 600;
    }
    .soloists {
      font-size: 12px;
    }
  }

  .intermissionLabel {
    flex-direction: row;
    align-self: center;
    margin: 10px 0 20px 0;
    font-size: 20px;
    font-weight: 600;
  }

  .lyricsReturn {
    display: block;
    margin-top: 5px;
    font-size: 14px;
  }

  .list {
    list-style-type: none;
    margin-top: 12px;
  }

  .postList {
    margin-top: 20px;
  }

  @media (min-width: 500px) {
    .list {
      -webkit-columns: 2;
      -moz-columns: 2;
      columns: 2;
    }
  }
  @media (min-width: 700px) {
    .list {
      -webkit-columns: 3;
      -moz-columns: 3;
      columns: 3;
    }
  }

  @media print {
    .no-print, .no-print * {
      display: none !important;
    }
  }
</style>

<div id="templates-wrapper" style="display:none;">
  <div id="song-entry" class="flex songWrapper">
    <div class="flex songHeading">
      <div class="songTitle">
        <span class="songTitleText" data-field="title"></span>
        <span class="hidden no-print" data-field="lyricsLink">&nbsp;(<a href="#"><em>lyrics</em></a>)</span>
      </div>
      <div class="flex songCredit" data-field="credit"></div>
    </div>
  </div>
  <div id="soloists" class="flex soloists" data-field="soloists"></div>
  <div id="featuring" class="flex soloists" data-field="featuring"></div>

  <div id="intermission" class="flex intermissionLabel">INTERMISSION</div>

  <li id="member" data-field="member"></li>
  <li id="donor" data-field="donor"></li>

  <div id="member-credit">
    <b><span data-field="role"></span>:&nbsp;</b><span data-field="name"></span>
  </div>

  <div id="lyrics-entry">
    <h3 data-field="songTitle"></h3>
    <div data-field="lyrics" class="lyrics"></div>
    <a href="#" class="lyricsReturn no-print"><em>to concert order</em></a>
  </div>
</div>

<div id="qcsf-body">
  <section id="top" class="no-print">
    Jump to section...<br />
    <a class="jumpLink" href="#concert_order">Concert&nbsp;Order</a>
    <a class="jumpLink" href="#directors_notes" id="directors_notes_jumplink">Director's&nbsp;Notes</a>
    <a class="jumpLink" href="#members">Our&nbsp;Members</a>
    <a class="jumpLink" href="#donors">Top&nbsp;Donors</a>
    <a class="jumpLink" href="#lyrics">Selected&nbsp;Lyrics</a>
  </section>

  <section>
    <h2>Land Acknowledgement</h2>
    <p>We acknowledge that the gatherings of the Queer Chorus of San Francisco take place on the unceded ancestral homeland of
    the Ramaytush Ohlone peoples, who are the original inhabitants and stewards of the San Francisco Peninsula. We have
    benefited from living and working in this place, which is their traditional homeland, and we believe our work of
    creating community should include the Ramaytush community.</p>
  </section>

  <section id="concert_order">
    <h2>Concert Order</h2>
    <a class="toTopLink no-print" href="#top"><em>to top</em></a>
    <div class="flex songList" id="song-list"></div>
  </section>

  <section id="directors_notes">
    <h2>Director's Notes</h2>
    <a class="toTopLink no-print" href="#top"><em>to top</em></a>
    <div id="directors-notes" data-field="directorsNotes"></div>
  </section>

  <section id="members">
    <h2>Our <span data-field="season"></span> Members</h2>
    <a class="toTopLink no-print" href="#top"><em>to top</em></a>
    <div id="member-credits" class="memberCredits"></div>
    <ul id="member-list" class="list memberList"></ul>
    <p class="postList">The Queer Chorus of San Francisco is always looking for talented, dedicated performers to become part of our wonderfully quirky family. If you are looking for a diverse community with whom you can share your creativity and vocal ability, QCSF has a home for you. <a href="https://www.qcsf.org/join-us.html">Find out more about how you can join!</a></p>
  </section>

  <section id="donors">
    <h2>Top Donors</h2>
    <a class="toTopLink no-print" href="#top"><em>to top</em></a>
    <p>Thank you to our generous donors, who make our work possible!</p>
    <ul id="donor-list" class="list donorList"></ul>
    <p class="postList">Your donations go toward programming, scholarships, travel for the chorus,
    and other community-building efforts.<br/><br/>
    <a href="https://www.qcsf.org/support-us.html">Become a donor today</a> and help us keep the music going &#x1F3B5;&#x1F3B6;</p>
  </section>


  <section id="lyrics">
    <h2>Lyrics</h2>
    <a class="toTopLink no-print" href="#top"><em>to top</em></a>
    <div id="lyrics-block"></div>
  </section>
</div>

<script id="program-data" src="./program-data.js"></script>

<script>
var hasRun = false;

(function() {
  if (hasRun) {
    return;
  }
  hasRun = true;

  const getSongForLyricsKey = (targetLyricsKey) => {
    return PROGRAM.songs.find(({lyricsKey}) => lyricsKey === targetLyricsKey);
  };

  const cloneElement = (elementId) => {
    const clonedElement = document.getElementById(elementId).cloneNode(true);
    clonedElement.elementId = undefined;
    clonedElement.setAttribute('data-injected', 'true');
    return clonedElement;
  }

  const injectFields = (element, fields) => {
    Object.entries(fields).forEach(([fieldName, value]) => {
      if (element.getAttribute?.('data-field') === fieldName) {
        element.innerText = value;
        return;
      }

      const field = element.querySelector(`[data-field="${fieldName}"]`);
      if (field) {
        field.innerText = value;
      }
    });

    return element;
  };

  const Components = {
    Soloists: {
      generate: (soloistsData) => {
        const element = cloneElement('soloists');

        const soloistsLabel = soloistsData?.length === 1 ? 'Soloist: ' : 'Soloists: ';
        // Use non-breaking spaces within a soloist's name so that line breaks occur between names
        const soloistsNames = soloistsData.map((soloist) => soloist.replaceAll(' ', '\xa0')).join(', ');

        injectFields(element, { soloists: soloistsLabel + soloistsNames });

        return element;
      },
      renderInto: (parentElement, soloistsData) => {
        const soloists = Components.Soloists.generate(soloistsData);

        parentElement.appendChild(soloists);
      },
    },
    Featuring: {
      generate: (featuredOne) => {
        const element = cloneElement('featuring');

        // Replace all spaces that aren't after commas with non-breaking spaces so we don't break in people's names
        const featuring = featuredOne.replaceAll(/([^,]) /g, '$1\xa0');

        injectFields(element, { featuring });

        return element;
      },
      renderInto: (parentElement, featuringData) => {
        featuringData.forEach((featuredOne) => {
          const featuring = Components.Featuring.generate(featuredOne);

          parentElement.appendChild(featuring);
        })
      },
    },
    SongEntry: {
      generate: (songData) => {
        const newSongEntry = cloneElement('song-entry');

        injectFields(newSongEntry, songData);

        if (songData.soloists?.length) {
          Components.Soloists.renderInto(newSongEntry, songData.soloists);
        }

        if (songData.featuring?.length) {
          Components.Featuring.renderInto(newSongEntry, songData.featuring);
        }

        if (songData.lyricsKey) {
          newSongEntry.setAttribute('data-lyricsKey', songData.lyricsKey);

          newSongEntry.querySelector('[data-field="lyricsLink"]').classList.remove('hidden');
        }

        return newSongEntry;
      },
      inject: (element) => {
        document.getElementById('song-list').appendChild(element);
      },
      render: (songData) => {
        const element = Components.SongEntry.generate(songData);
        Components.SongEntry.inject(element);
      },
    },
    Intermission: {
      render: () => {
        document.getElementById('song-list').appendChild(cloneElement('intermission'));
      },
    },
    DirectorsNotes: {
      render: () => {
        if (PROGRAM.directorsNotes) {
          document.querySelector('[data-field="directorsNotes"]').innerHTML = PROGRAM.directorsNotes;
        } else {
          document.getElementById('directors_notes').classList.add('hidden');
          document.getElementById('directors_notes_jumplink').classList.add('hidden');
        }
      },
    },
    LyricsEntry: {
      generate: ({lyricsKey, lyrics}) => {
        const song = getSongForLyricsKey(lyricsKey);
        if (!song) {
          console.warn('No song found matching lyricsKey', lyricsKey);
        }
        const newLyricsEntry = cloneElement('lyrics-entry');

        injectFields(newLyricsEntry, {songTitle: song.title, lyrics});

        newLyricsEntry.setAttribute('data-lyricsKey', lyricsKey);

        return newLyricsEntry;
      },

      inject: (element) => {
        document.getElementById('lyrics-block').appendChild(element);
      },

      render: (lyricsData) => {
        const element = Components.LyricsEntry.generate(lyricsData);
        Components.LyricsEntry.inject(element);
      },
    },
    MemberHeading: {
      render: () => {
        injectFields(document, { season: PROGRAM.season });
      },
    },
    MemberListItem: {
      generate: (member) => {
        const newMember = cloneElement('member');

        return injectFields(newMember, {member});
      },
      inject: (element) => {
        document.getElementById('member-list').appendChild(element);
      },
      render: (member) => {
        const element = Components.MemberListItem.generate(member);
        Components.MemberListItem.inject(element);
      },
    },
    MemberCreditItem: {
      generate: (memberInfo) => {
        const newMember = cloneElement('member-credit');

        return injectFields(newMember, memberInfo);
      },
      inject: (element) => {
        document.getElementById('member-credits').appendChild(element);
      },
      render: (memberInfo) => {
         const element = Components.MemberCreditItem.generate(memberInfo);
        Components.MemberCreditItem.inject(element);
      }
    },
    DonorListItem: {
      generate: (donor) => {
        const newDonor = cloneElement('donor');

        return injectFields(newDonor, {donor});
      },
      inject: (element) => {
        document.getElementById('donor-list').appendChild(element);
      },
      render: (donor) => {
        const element = Components.DonorListItem.generate(donor);
        Components.DonorListItem.inject(element);
      },
    }
  };

  const onSongClick = (e) => {
    e.preventDefault();

    const lyricsKey = e.target.closest('[data-lyricsKey]')?.getAttribute('data-lyricsKey');

    const target = document.getElementById('lyrics-block').querySelector(`[data-lyricsKey="${lyricsKey}"]`);
    target?.scrollIntoView({ behavior: 'smooth' });
  }

  const onLyricsBackClick = (e) => {
    e.preventDefault();

    const lyricsKey = e.target.closest('[data-lyricsKey]')?.getAttribute('data-lyricsKey');

    const target = document.getElementById('song-list').querySelector(`[data-lyricsKey="${lyricsKey}"]`);
    target?.scrollIntoView({ behavior: 'smooth' });
  }

  const renderSongList = () => {
    PROGRAM.songs.forEach((song) => {
      if (song === 'intermission') {
        Components.Intermission.render();
      } else {
        Components.SongEntry.render(song);
      }
    });
  };

  const renderDirectorsNotes = () => {
    Components.DirectorsNotes.render();
  }

  const renderLyrics = () => {
    PROGRAM.songs.forEach(({lyricsKey}) => {
      if (!lyricsKey || !PROGRAM.lyrics[lyricsKey]) {
        return;
      }

      Components.LyricsEntry.render({ lyricsKey, lyrics: PROGRAM.lyrics[lyricsKey] });
    });
  };

  const renderMembersList = () => {
    Components.MemberHeading.render();
    PROGRAM.members.singers.forEach((member) => {
      Components.MemberListItem.render(member);
    });
    PROGRAM.members.credits.forEach((memberInfo) => {
      Components.MemberCreditItem.render(memberInfo);
    });
  };

  const renderDonorsList = () => {
    PROGRAM.donors.forEach((donor) => {
      Components.DonorListItem.render(donor);
    });
  };

  const addLyricsLinks = () => {
    document.getElementById('song-list').querySelectorAll(`[data-lyricsKey] a`).forEach((element) => {
      element.addEventListener('click', onSongClick);
    });

    document.getElementById('lyrics-block').querySelectorAll(`[data-lyricsKey]`).forEach((element) => {
      element.addEventListener('click', onLyricsBackClick);
    });
  };

  const breakSandbox = () => {
    // This is needed so that the margin-scroll-top property on the #top link doesn't get cut off by the container
    document.getElementById('qcsf-body').parentElement?.style?.removeProperty('overflow-y');

    // Hide certain elements of the page from printer view for nice-looking hard copies
    document.querySelector('.cento-header')?.classList.add('no-print');
    setTimeout(() => {
      // our code runs before these elements are on the page, so we gotta wait
      document.querySelector('.footer-wrap')?.classList.add('no-print');
      document.querySelector('.floating_button')?.classList.add('no-print');
    }, 50);
  };

  const main = () => {
    breakSandbox();

    renderSongList();
    renderDirectorsNotes();
    renderMembersList();
    renderDonorsList();
    renderLyrics();

    addLyricsLinks();
  };

  main();
})();
</script>


